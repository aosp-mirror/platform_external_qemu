# -*- coding: utf-8 -*-
# Copyright 2023 - The Android Open Source Project
#
# Licensed under the Apache License, Version 2.0 (the',  help='License');
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an',  help='AS IS' BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
import platform
from pathlib import Path
from typing import Dict, Set, Tuple
from aemu.process.bazel import Bazel
from aemu.configure.libraries import BazelLib, CMakeLib, CargoLib

from aemu.toolchains.toolchain_generator import ToolchainGenerator
from aemu.process.runner import run
from aemu.process.cmake import CMake
from aemu.process.cargo import Cargo


class QemuBuilder:
    """Configures the QEMU build for the specified platform.

    This class generates toolchain wrapper functions, a Meson toolchain configuration file,
    and package config files derived from the Bazel source build needed for QEMU. It can also
    invoke Meson setup to configure QEMU and optionally compile the source.

    Args:
        dest (str): The destination path for the configuration.
        generator (ToolchainGenerator): The toolchain generator to use.

    Attributes:
        TOOLCHAIN_DIR (str): The directory for the toolchain.
    """

    TOOLCHAIN_DIR = "toolchain"

    def __init__(self, aosp, dest, toolchain_dir, ccache, generator) -> None:
        """Initialize the QemuBuilder instance.

        Args:
            dest (str): The destination path for the configuration.
            generator_klazz (ToolchainGenerator): The toolchain generator instance.
        """
        self.aosp: Path = Path(aosp).absolute()
        self.dest: Path = Path(dest).absolute()
        self.toolchain: Path = Path(toolchain_dir).absolute()
        self.dest.mkdir(parents=True, exist_ok=True)
        self.bazel: Bazel = Bazel(self.aosp, self.dest)
        self.cmake: CMake = CMake(self.aosp, self.toolchain, self.dest)
        CMakeLib.builder = self.cmake
        BazelLib.builder = self.bazel

        # Initialize the toolchain generator with the specified destination and an empty suffix.
        # This generator will be used to manage toolchain-related configurations.
        self.toolchain_generator: ToolchainGenerator = generator
        if ccache:
            self.toolchain_generator.ccache = Path(ccache).absolute()
        self.toolchain_generator.bazel = self.bazel
        CargoLib.builder = Cargo(self.aosp, self.toolchain_generator, self.dest)

    def host(self) -> str:
        return platform.system().lower()

    def configure_meson(self, meson_flags):
        """Configure the QEMU build using Meson build system."""
        # Generate the toolchain wrappers.
        self.toolchain_generator.gen_toolchain()

        meson_flags = [] if meson_flags is None else meson_flags
        # # Write toolchain and host configurations.
        self.toolchain_generator.write_toolchain_config()

        # # Create pkgconfig .pc files for specified Bazel packages.
        for package in self.packages():
            package.generate_pkg_config(
                self.dest,
                self.toolchain / ToolchainGenerator.PKGCFG_DIR,
            )

        # Write the config-host.mak file.
        host_mak = f"# Automatically generated by qemu-build - do not modify \n\n"
        host_mak += "all:\n"
        with open(self.dest / "config-host.mak", "w", encoding="utf-8") as f:
            f.write("\n".join(self.config_mak()))

        # Invoke Meson setup with the proper configuration.
        run(
            [self.toolchain / "meson"]
            + ["setup", self.dest]
            + self.meson_config()
            + [self.toolchain / "aosp-cl.ini"]
            + meson_flags,
            cwd=self.aosp / "external" / "qemu",
            toolchain_path=self.toolchain,
        )

    def packages(self):
        """Set of bazel targets for which we are going to generate pkgconfig discovery files.

        Subclasses should override these to provide platform specific libraries/shims that might be needed.
        """
        raise ValueError("Subclasses need to provide this.")

    def meson_config(self):
        """The set of meson configuration flags that need to be provided to meson setup to configure qemu"""
        raise ValueError("Subclasses need to provide this.")

    def config_mak(self):
        """The config.mak file needed by meson to configure qemu."""
        raise ValueError("Subclasses need to provide this.")
