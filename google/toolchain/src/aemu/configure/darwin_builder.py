# -*- coding: utf-8 -*-
# Copyright 2023 - The Android Open Source Project
#
# Licensed under the Apache License, Version 2.0 (the',  help='License');
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an',  help='AS IS' BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

from aemu.configure.base_builder import QemuBuilder, LibInfo
import sys


class DarwinBuilder(QemuBuilder):
    # Generated by runnning configure:
    #
    # ./configure --target-list=aarch64-softmmu --audio-drv-list=coreaudio
    # --enable-fdt=internal --without-default-features --cpu=aarch64
    # --disable-alsa --disable-attr --disable-auth-pam --disable-blkio
    # --disable-bochs --disable-bpf --disable-brlapi --disable-bsd-user
    # --disable-bzip2 --disable-canokey --disable-cap-ng --disable-capstone
    # --disable-cloop --enable-cocoa --disable-colo-proxy --enable-coreaudio
    # --disable-curl --disable-curses --disable-dbus-display
    # --disable-debug-tcg --disable-dmg --disable-docs --disable-dsound
    # --disable-fuse-lseek --disable-fuse --disable-gcrypt --disable-gettext
    # --disable-gio --disable-glusterfs --disable-gnutls
    # --disable-gtk-clipboard --disable-gtk --disable-guest-agent-msi
    # --disable-guest-agent --disable-hax --enable-hvf --disable-iconv
    # --disable-jack --disable-keyring --disable-l2tpv3 --disable-libdaxctl
    # --disable-libdw --disable-libiscsi --disable-libnfs --disable-libpmem
    # --disable-libssh --disable-libudev --disable-libusb --disable-libvduse
    # --disable-linux-aio --disable-linux-io-uring --disable-linux-user
    # --disable-lzfse --disable-lzo --disable-membarrier --disable-modules
    # --disable-mpath --disable-netmap --disable-nettle --disable-numa
    # --disable-nvmm --disable-opengl --disable-oss --disable-parallels
    # --disable-pipewire --disable-png --disable-pvrdma --disable-qcow1
    # --disable-qed --disable-qga-vss --disable-rbd --disable-rdma
    # --disable-replication --disable-sdl-image --disable-sdl --disable-seccomp
    # --disable-selinux --disable-slirp-smbd --disable-slirp
    # --disable-smartcard --disable-snappy --disable-sndio --disable-sparse
    # --disable-spice-protocol --disable-spice --disable-stack-protector
    # --disable-tpm --disable-u2f --disable-usb-redir --disable-vde
    # --disable-vdi --disable-vduse-blk-export --disable-vfio-user-server
    # --disable-vhdx --disable-virglrenderer --disable-virtfs-proxy-helper
    # --disable-virtfs --disable-vmdk --enable-vmnet --disable-vnc-jpeg
    # --disable-vnc-sasl --disable-vnc --disable-vpc --disable-vte
    # --disable-vvfat --disable-whpx --disable-xen-pci-passthrough
    # --disable-xen --disable-xkbcommon --disable-zstd --disable-avx2
    # --disable-avx512bw --disable-avx512f --disable-crypto-afalg --disable-kvm
    # --enable-live-block-migration --disable-malloc-trim
    # --disable-multiprocess --disable-pa --enable-system --enable-tcg
    # --enable-tools --enable-user --disable-vhost-crypto
    # --disable-vhost-kernel --disable-vhost-net
    # --disable-vhost-user-blk-server --disable-vhost-user --disable-vhost-vdpa
    # --cc=/tmp/out/toolchain/gcc --cxx=/tmp/out/toolchain/g++
    # --objcc=/tmp/out/toolchain/g++
    def meson_config(self):
        return [
            "-Dandroid=enabled",
            "-Daudio_drv_list=coreaudio",
            "-Dfdt=auto",
            "-Dalsa=disabled",
            "-Dattr=disabled",
            "-Dauth_pam=disabled",
            "-Dblkio=disabled",
            "-Dbochs=disabled",
            "-Dbpf=disabled",
            "-Dbrlapi=disabled",
            "-Dbzip2=disabled",
            "-Dcanokey=disabled",
            "-Dcap_ng=disabled",
            "-Dcapstone=disabled",
            "-Dcloop=disabled",
            "-Dcocoa=enabled",
            "-Dcolo_proxy=disabled",
            "-Dcoreaudio=enabled",
            "-Dcurl=disabled",
            "-Dcurses=disabled",
            "-Ddbus_display=disabled",
            "-Ddmg=disabled",
            "-Ddsound=disabled",
            "-Dfuse_lseek=disabled",
            "-Dfuse=disabled",
            "-Dgcrypt=disabled",
            "-Dgettext=disabled",
            "-Dgio=disabled",
            "-Dglusterfs=disabled",
            "-Dgnutls=disabled",
            "-Dgtk_clipboard=disabled",
            "-Dgtk=disabled",
            "-Dguest_agent_msi=disabled",
            "-Dguest_agent=disabled",
            "-Dhvf=enabled",
            "-Diconv=disabled",
            "-Djack=disabled",
            "-Dkeyring=disabled",
            "-Dl2tpv3=disabled",
            "-Dlibdaxctl=disabled",
            "-Dlibdw=disabled",
            "-Dlibiscsi=disabled",
            "-Dlibnfs=disabled",
            "-Dlibpmem=disabled",
            "-Dlibssh=disabled",
            "-Dlibudev=disabled",
            "-Dlibusb=disabled",
            "-Dlibvduse=disabled",
            "-Dlinux_aio=disabled",
            "-Dlinux_io_uring=disabled",
            "-Dlzfse=disabled",
            "-Dlzo=disabled",
            "-Dmembarrier=disabled",
            "-Dmodules=disabled",
            "-Dmpath=disabled",
            "-Dnetmap=disabled",
            "-Dnettle=disabled",
            "-Dnuma=disabled",
            "-Dnvmm=disabled",
            "-Dopengl=disabled",
            "-Doss=disabled",
            "-Dparallels=disabled",
            "-Dpipewire=disabled",
            "-Dpng=disabled",
            "-Dpvrdma=disabled",
            "-Dqcow1=disabled",
            "-Dqed=disabled",
            "-Dqga_vss=disabled",
            "-Drbd=disabled",
            "-Drdma=disabled",
            "-Dreplication=disabled",
            "-Dsdl_image=disabled",
            "-Dsdl=disabled",
            "-Dseccomp=disabled",
            "-Dselinux=disabled",
            "-Dslirp_smbd=disabled",
            "-Dslirp=disabled",
            "-Dsmartcard=disabled",
            "-Dsnappy=disabled",
            "-Dsndio=disabled",
            "-Dsparse=disabled",
            "-Dspice_protocol=disabled",
            "-Dspice=disabled",
            "-Dstack_protector=disabled",
            "-Dtpm=disabled",
            "-Du2f=disabled",
            "-Dusb_redir=disabled",
            "-Dvde=disabled",
            "-Dvdi=disabled",
            "-Dvduse_blk_export=disabled",
            "-Dvfio_user_server=disabled",
            "-Dvhdx=disabled",
            "-Dvirglrenderer=disabled",
            "-Dvirtfs_proxy_helper=disabled",
            "-Dvirtfs=disabled",
            "-Dvmdk=disabled",
            "-Dvmnet=enabled",
            "-Dvnc_jpeg=disabled",
            "-Dvnc_sasl=disabled",
            "-Dvnc=disabled",
            "-Dvpc=disabled",
            "-Dvte=disabled",
            "-Dvvfat=disabled",
            "-Dwhpx=disabled",
            "-Dxen_pci_passthrough=disabled",
            "-Dxen=disabled",
            "-Dxkbcommon=disabled",
            "-Dzstd=disabled",
            "-Davx2=disabled",
            "-Davx512bw=disabled",
            "-Davx512f=disabled",
            "-Dcrypto_afalg=disabled",
            "-Dkvm=disabled",
            "-Dlive_block_migration=enabled",
            "-Dmalloc_trim=disabled",
            "-Dmultiprocess=disabled",
            "-Dpa=disabled",
            "-Dtools=enabled",
            "-Dvhost_crypto=disabled",
            "-Dvhost_kernel=disabled",
            "-Dvhost_net=disabled",
            "-Dvhost_user_blk_server=disabled",
            "-Dvhost_user=disabled",
            "-Dvhost_vdpa=disabled",
            "-Dauto_features=disabled",
            "-Ddocs=disabled",
            "-Db_pie=false",
            f"-Dprefix={self.dest / 'release'}",
            "--native-file",
        ]

    def packages(self):
        """Set of bazel targets for which we are going to generate pkgconfig discovery files.

        Subclasses can override these to provide platform specific libraries/shims that might be needed.
        """
        includes = [
            self.aosp / "external" / "glib",
            self.aosp / "external" / "glib" / "gmodule",
            self.aosp / "external" / "glib" / "os" / "darwin",
            self.aosp / "external" / "glib" / "os" / "darwin" / "glib",
            self.aosp / "external" / "glib" / "os" / "darwin" / "gmodule",
            "${libdir}",
        ]

        return [
            LibInfo("//external/dtc:libfdt", "1.6.0", {}),
            LibInfo("@glib//:gmodule-static", "2.77.2", {}),
            LibInfo("@glib//:glib-darwin", "2.77.2", {
                "link_flags" : "-lobjc -framework Foundation",
            }),
            LibInfo("@zlib//:zlib", "1.2.10", {}),
            LibInfo(
                "@glib//:glib-static",
                "2.77.2",
                {
                    "name" : "glib-2.0",
                    "includes": [str(x) for x in includes],
                    "Requires": "pcre2, gmodule-static, glib-darwin",
                    "link_flags": "-liconv",
                },
            ),
            LibInfo("@pixman//:pixman-1", "0.42.3", {"Requires": "pixman_simd"}),
            LibInfo("@pixman//:pixman_simd", "0.42.3", {}),
            LibInfo("@pcre2//:pcre2", "10.42", {}),
            # etc.. etc..
            # LibInfo("/external/curl//:curl", "0.21.8"),
        ]

    def config_mak(self):
        return [
            "CONFIG_POSIX=y",
            "CONFIG_DARWIN=y",
            f"SRC_PATH={self.aosp / 'external' / 'qemu'}",
            "TARGET_DIRS=aarch64-softmmu riscv64-softmmu x86_64-softmmu",
            "CONFIG_BSD=y",
            "ROMS=",
            f"PYTHON={sys.executable} -B",
            "GENISOIMAGE=",
            f"MESON={self.toolchain_generator.dest / 'meson'}",
            f"NINJA={self.toolchain_generator.dest / 'ninja'}",
            f"PKG_CONFIG={self.toolchain_generator.dest / 'pkg-config'}",
            f"CC={self.toolchain_generator.dest / 'cc'}",
            "EXESUF=",
            "TCG_TESTS_TARGETS=",
        ]
