# We might be running in cross compile build, so setup the required paths and includes..
cmake_minimum_required(VERSION 3.5)
if(NOT ANDROID_QEMU2_TOP_DIR)
  set(CMAKE_CXX_STANDARD 17)
  project(protobuf)
  include(android)
  include(prebuilts)
endif()
if(NOT TARGET zlib)
  # Cross build needs zlib for protoc.
  add_subdirectory(../zlib zlib)
endif()

set(ZLIB_LIBRARIES zlib)

set(protobuf_DEBUG_POSTFIX "d" CACHE STRING "Default debug postfix")

set(protobuf_source_dir "${ANDROID_QEMU2_TOP_DIR}/../protobuf")
# Path to main configure script
set(protobuf_CONFIGURE_SCRIPT "${protobuf_source_dir}/configure.ac")

# Parse configure script
set(protobuf_AC_INIT_REGEX
    "^AC_INIT\\(\\[([^]]+)\\],\\[([^]]+)\\],\\[([^]]+)\\],\\[([^]]+)\\]\\)$")
file(STRINGS "${protobuf_CONFIGURE_SCRIPT}" protobuf_AC_INIT_LINE LIMIT_COUNT 1
     REGEX "^AC_INIT")
# Description
string(REGEX REPLACE "${protobuf_AC_INIT_REGEX}" "\\1" protobuf_DESCRIPTION
                     "${protobuf_AC_INIT_LINE}")
# Version
string(REGEX REPLACE "${protobuf_AC_INIT_REGEX}" "\\2" protobuf_VERSION_STRING
                     "${protobuf_AC_INIT_LINE}")
# Contact
string(REGEX REPLACE "${protobuf_AC_INIT_REGEX}" "\\3" protobuf_CONTACT
                     "${protobuf_AC_INIT_LINE}")
# Parse version tweaks
set(protobuf_VERSION_REGEX "^([0-9]+)\\.([0-9]+)\\.([0-9]+).*$")
string(REGEX REPLACE "${protobuf_VERSION_REGEX}" "\\1" protobuf_VERSION_MAJOR
                     "${protobuf_VERSION_STRING}")
string(REGEX REPLACE "${protobuf_VERSION_REGEX}" "\\2" protobuf_VERSION_MINOR
                     "${protobuf_VERSION_STRING}")
string(REGEX REPLACE "${protobuf_VERSION_REGEX}" "\\3" protobuf_VERSION_PATCH
                     "${protobuf_VERSION_STRING}")
# Package version
set(protobuf_VERSION
    "${protobuf_VERSION_MAJOR}.${protobuf_VERSION_MINOR}.${protobuf_VERSION_PATCH}"
)
set(PROTO_DESC
    "${protobuf_DESCRIPTION}, Version: ${protobuf_VERSION} (${protobuf_VERSION_STRING})"
)

add_definitions(-DGOOGLE_PROTOBUF_CMAKE_BUILD)
if(protobuf_BUILD_SHARED_LIBS)
  set(protobuf_SHARED_OR_STATIC "SHARED")
else(protobuf_BUILD_SHARED_LIBS)
  set(protobuf_SHARED_OR_STATIC "STATIC")
endif()

if(WINDOWS_MSVC_X86_64)
  add_definitions(-utf-8)
  add_definitions(-bigobj)
endif()

add_definitions(-DUNICODE -D_UNICODE)

include(${protobuf_source_dir}/cmake/libprotobuf-lite.cmake)
include(${protobuf_source_dir}/cmake/libprotobuf.cmake)

if(NOT CROSSCOMPILE)
  include(${protobuf_source_dir}/cmake/libprotoc.cmake)
  include(${protobuf_source_dir}/cmake/protoc.cmake)


  android_target_dependency(protoc all RUNTIME_OS_DEPENDENCIES)
  android_target_properties(protoc all "${RUNTIME_OS_PROPERTIES}")

  if(NOT DEFINED protobuf_PROTOC_EXE)
    set(protobuf_PROTOC_EXE protoc)
  endif(NOT DEFINED protobuf_PROTOC_EXE)
  set(PROTOBUF_PROTOC_EXECUTABLE "$<TARGET_FILE:protoc>"
      CACHE PATH "Protocol buffer executable" FORCE)
else()
  android_compile_for_host(protoc ${CMAKE_CURRENT_LIST_DIR} PROTOBUF_EXE)
  set(PROTOBUF_PROTOC_EXECUTABLE ${PROTOBUF_EXE}
      CACHE PATH "Protocol buffer executable" FORCE)
  add_executable(protobuf::protoc IMPORTED GLOBAL)
  set_target_properties(
    protobuf::protoc PROPERTIES IMPORTED_LOCATION
                                "${PROTOBUF_PROTOC_EXECUTABLE}")
endif()

set(PROTOBUF_LIBRARY "${PROTO_DESC}")
set(PROTOBUF_INCLUDE_DIR "${protobuf_source_dir}/src")

# Later versions of cmake want this to be lower case..
set(Protobuf_INCLUDE_DIR "${PROTOBUF_INCLUDE_DIR}")
set(Protobuf_LIBRARY "${PROTOBUF_LIBRARY}")
set(Protobuf_PROTOC_EXECUTABLE "${PROTOBUF_PROTOC_EXECUTABLE}")
find_package(Protobuf REQUIRED)
if(NOT "${_PROTOBUF_PROTOC_EXECUTABLE_VERSION}" VERSION_EQUAL
   "${Protobuf_VERSION}")
  message(
    STATUS
      "It's safe to ignore version warnings, it's a result of compiling protoc in the tree with CMake version > 3.5."
  )
endif()

android_license(TARGET "protobuf::libprotobuf" LIBNAME protobuf SPDX "BSD-3-Clause" LICENSE "BSD-3-Clause" LOCAL "${protobuf_source_dir}/NOTICE")
android_license(TARGET "libprotobuf" LIBNAME protobuf SPDX "BSD-3-Clause" LICENSE "BSD-3-Clause" LOCAL "${protobuf_source_dir}/NOTICE")
